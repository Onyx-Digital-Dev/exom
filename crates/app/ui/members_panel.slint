// Right panel - Members and settings

import { Theme } from "theme.slint";
import { SecondaryButton, DangerButton, OnlineIndicator, RoleBadge, HostBadge, Separator, StatusText, EmptyState } from "components.slint";

// Member data
export struct MemberItem {
    id: string,
    name: string,
    role: string,
    is-online: bool,
    is-host: bool,
    is-you: bool,
    activity-hint: string,  // "Active", "5m", "2h", etc.
}

// Chest file data
export struct ChestFileItem {
    name: string,
    is-directory: bool,
    size: string,
    sync-status: string,
}

export component MembersPanel inherits Rectangle {
    in property <[MemberItem]> members;
    in property <[ChestFileItem]> chest-files;
    in property <string> chest-path;
    in property <string> chest-status;
    in property <string> current-user-id;
    in property <string> current-user-role: "Fellow";  // User's role for permission hints
    in property <string> action-status;  // Status for member actions
    in property <string> network-status: "Working offline";
    in property <bool> is-network-connected: false;
    in property <string> invite-url: "";

    callback promote-member(string);
    callback demote-member(string);
    callback kick-member(string);
    callback load-chest-files();
    callback copy-invite();

    property <string> selected-member-id;
    property <bool> show-context-menu: false;
    property <bool> show-chest: false;

    background: Theme.color-panel;
    width: Theme.right-panel-width;

    VerticalLayout {
        // Header with tabs
        Rectangle {
            height: 48px;
            background: Theme.color-panel;

            HorizontalLayout {
                padding-left: Theme.pad-md;
                padding-right: Theme.pad-md;
                spacing: Theme.pad-lg;
                alignment: start;

                // Members tab
                TouchArea {
                    width: 70px;
                    height: 48px;
                    clicked => { root.show-chest = false; }

                    Text {
                        width: 100%;
                        height: 100%;
                        text: "Members";
                        color: !root.show-chest ? Theme.color-text : Theme.color-text-muted;
                        font-size: Theme.text-md;
                        font-weight: !root.show-chest ? 500 : 400;
                        vertical-alignment: center;
                    }
                }

                // Chest tab
                TouchArea {
                    width: 50px;
                    height: 48px;
                    clicked => {
                        root.show-chest = true;
                        root.load-chest-files();
                    }

                    Text {
                        width: 100%;
                        height: 100%;
                        text: "Chest";
                        color: root.show-chest ? Theme.color-text : Theme.color-text-muted;
                        font-size: Theme.text-md;
                        font-weight: root.show-chest ? 500 : 400;
                        vertical-alignment: center;
                    }
                }
            }
        }

        Separator {}

        if !root.show-chest: VerticalLayout {
            vertical-stretch: 1;

            // Member list
            Flickable {
                vertical-stretch: 1;

                VerticalLayout {
                    padding: Theme.pad-sm;
                    spacing: 2px;

                    // Guidance when alone in the hall
                    if root.members.length <= 1: VerticalLayout {
                        vertical-stretch: 1;
                        alignment: center;
                        spacing: Theme.pad-sm;
                        padding: Theme.pad-md;

                        Text {
                            text: root.members.length == 0 ? "No Members" : "Just You";
                            color: Theme.color-text-muted;
                            font-size: Theme.text-md;
                            horizontal-alignment: center;
                        }

                        Text {
                            text: root.invite-url != "" ? "Share the invite link below to bring others in." : "Go online to invite others.";
                            color: Theme.color-text-dim;
                            font-size: Theme.text-sm;
                            horizontal-alignment: center;
                            wrap: word-wrap;
                        }
                    }

                    for member in root.members: Rectangle {
                        height: 44px;
                        background: member.id == root.selected-member-id ? Theme.color-panel-elevated : transparent;
                        border-radius: Theme.radius-sm;

                        touch := TouchArea {
                            clicked => {
                                if root.selected-member-id == member.id {
                                    root.selected-member-id = "";
                                } else {
                                    root.selected-member-id = member.id;
                                }
                            }
                        }

                        HorizontalLayout {
                            padding-left: Theme.pad-sm;
                            padding-right: Theme.pad-sm;
                            spacing: Theme.pad-sm;
                            alignment: start;

                            Rectangle {
                                width: 16px;
                                height: 44px;

                                OnlineIndicator {
                                    y: 18px;
                                    online: member.is-online;
                                }
                            }

                            VerticalLayout {
                                alignment: center;
                                horizontal-stretch: 1;
                                spacing: 2px;

                                HorizontalLayout {
                                    spacing: Theme.pad-xs;

                                    Text {
                                        text: member.name;
                                        // Dim offline users
                                        color: member.is-online ? Theme.color-text : Theme.color-text-dim;
                                        font-size: Theme.text-md;
                                        overflow: elide;
                                    }

                                    if member.is-you: Text {
                                        text: "(You)";
                                        color: Theme.color-accent;
                                        font-size: Theme.text-sm;
                                        vertical-alignment: center;
                                    }

                                    if member.is-host: HorizontalLayout {
                                        spacing: 4px;
                                        HostBadge {}
                                        Text {
                                            text: "(Host)";
                                            color: Theme.color-text-muted;
                                            font-size: Theme.text-xs;
                                            vertical-alignment: center;
                                        }
                                    }
                                }

                                HorizontalLayout {
                                    spacing: Theme.pad-xs;

                                    RoleBadge {
                                        role: member.role;
                                        subtle: true;
                                    }

                                    // Show activity hint or offline status
                                    if member.activity-hint != "": Text {
                                        text: member.activity-hint;
                                        color: member.activity-hint == "Active" ? Theme.color-online : Theme.color-text-dim;
                                        font-size: Theme.text-xs;
                                        vertical-alignment: center;
                                    }

                                    if !member.is-online && member.activity-hint == "": Text {
                                        text: "(offline)";
                                        color: Theme.color-text-dim;
                                        font-size: Theme.text-xs;
                                        vertical-alignment: center;
                                    }
                                }
                            }
                        }
                    }
                }
            }

            // Context actions for selected member
            if root.selected-member-id != "" && root.selected-member-id != root.current-user-id: Rectangle {
                // Check if user has management permissions (Moderator or higher)
                property <bool> can-manage: root.current-user-role == "Builder" ||
                                           root.current-user-role == "Prefect" ||
                                           root.current-user-role == "Moderator";

                height: root.action-status != "" ? 120px : (can-manage ? 80px : 60px);
                background: Theme.color-panel-elevated;

                VerticalLayout {
                    padding: Theme.pad-sm;
                    spacing: Theme.pad-xs;

                    // Show permission hint if no permissions
                    if !can-manage: Text {
                        text: "Only Moderators and above can manage members";
                        color: Theme.color-text-dim;
                        font-size: Theme.text-xs;
                        horizontal-alignment: center;
                        wrap: word-wrap;
                    }

                    if can-manage: HorizontalLayout {
                        spacing: Theme.pad-xs;

                        SecondaryButton {
                            label: "Promote";
                            horizontal-stretch: 1;
                            clicked => { root.promote-member(root.selected-member-id); }
                        }

                        SecondaryButton {
                            label: "Demote";
                            horizontal-stretch: 1;
                            clicked => { root.demote-member(root.selected-member-id); }
                        }
                    }

                    if can-manage: DangerButton {
                        label: "Kick";
                        clicked => { root.kick-member(root.selected-member-id); root.selected-member-id = ""; }
                    }

                    // Action status
                    if root.action-status != "": Text {
                        text: root.action-status;
                        color: Theme.color-text-muted;
                        font-size: Theme.text-xs;
                        horizontal-alignment: center;
                    }
                }
            }
        }

        // Chest view
        if root.show-chest: VerticalLayout {
            vertical-stretch: 1;

            // Path display
            Rectangle {
                height: 32px;
                background: Theme.color-panel-elevated;

                Text {
                    x: Theme.pad-sm;
                    width: parent.width - Theme.pad-md;
                    height: 100%;
                    text: root.chest-path;
                    color: Theme.color-text-muted;
                    font-size: Theme.text-xs;
                    vertical-alignment: center;
                    overflow: elide;
                }
            }

            // File list
            Flickable {
                vertical-stretch: 1;

                VerticalLayout {
                    padding: Theme.pad-sm;
                    spacing: 2px;

                    // Empty state when no files
                    if root.chest-files.length == 0: EmptyState {
                        title: "Chest Empty";
                        description: "Shared files will appear here.";
                        vertical-stretch: 1;
                    }

                    for file in root.chest-files: Rectangle {
                        height: 36px;
                        background: transparent;

                        HorizontalLayout {
                            padding-left: Theme.pad-sm;
                            padding-right: Theme.pad-sm;
                            spacing: Theme.pad-sm;

                            Text {
                                width: 40px;
                                text: file.is-directory ? "[DIR]" : "";
                                color: Theme.color-text-dim;
                                font-size: Theme.text-xs;
                            }

                            Text {
                                text: file.name;
                                color: Theme.color-text;
                                font-size: Theme.text-sm;
                                horizontal-stretch: 1;
                                overflow: elide;
                            }

                            Text {
                                text: file.size;
                                color: Theme.color-text-muted;
                                font-size: Theme.text-xs;
                            }
                        }
                    }
                }
            }

            // Sync status
            Rectangle {
                height: 28px;
                background: Theme.color-panel-elevated;

                Text {
                    x: Theme.pad-sm;
                    width: parent.width - Theme.pad-md;
                    height: 100%;
                    text: root.chest-status;
                    color: Theme.color-text-dim;
                    font-size: Theme.text-xs;
                    vertical-alignment: center;
                }
            }
        }

        Separator {}

        // Hall info footer (network status + invite)
        Rectangle {
            height: root.invite-url != "" ? 80px : 48px;
            background: Theme.color-panel;

            VerticalLayout {
                padding: Theme.pad-sm;
                spacing: Theme.pad-xs;

                // Network status row
                HorizontalLayout {
                    spacing: Theme.pad-sm;
                    alignment: start;

                    Rectangle {
                        width: 8px;
                        height: 8px;
                        border-radius: 4px;
                        background: root.is-network-connected ? Theme.color-online : Theme.color-text-dim;
                        y: 5px;
                    }

                    Text {
                        text: root.network-status;
                        color: Theme.color-text-muted;
                        font-size: Theme.text-sm;
                        vertical-alignment: center;
                    }
                }

                // Invite URL row (when hosting or connected)
                if root.invite-url != "": HorizontalLayout {
                    spacing: Theme.pad-xs;

                    Text {
                        text: root.invite-url;
                        color: Theme.color-text-dim;
                        font-size: Theme.text-xs;
                        horizontal-stretch: 1;
                        overflow: elide;
                        vertical-alignment: center;
                    }

                    SecondaryButton {
                        label: "Copy";
                        clicked => { root.copy-invite(); }
                    }
                }
            }
        }
    }
}
