// Exom Main Window

import { Theme } from "theme.slint";
import { VerticalSeparator, Button, SecondaryButton } from "components.slint";
import { AuthView } from "auth.slint";
import { HallsPanel, HallItem } from "halls_panel.slint";
import { ChatPanel, EmptyChatPanel, MessageItem } from "chat_panel.slint";
import { MembersPanel, MemberItem, ChestFileItem } from "members_panel.slint";
import { HallSwitcher, SwitcherHallItem } from "hall_switcher.slint";
import { WorkspacePanel, Launcher, TabItem, FileItem, LauncherItem, LaunchedToolItem, PinnedLauncherItem } from "workspace_panel.slint";

export { HallItem, MessageItem, MemberItem, ChestFileItem, SwitcherHallItem, TabItem, FileItem, LauncherItem, LaunchedToolItem, PinnedLauncherItem }

export component MainWindow inherits Window {
    title: "Exom";
    background: Theme.color-bg;
    min-width: 900px;
    min-height: 600px;
    preferred-width: 1200px;
    preferred-height: 800px;

    // Auth state
    in-out property <bool> is-logged-in: false;
    in-out property <string> current-username;
    in-out property <string> auth-error;

    // Hall state
    in-out property <[HallItem]> halls: [];
    in-out property <string> current-hall-id;
    in-out property <string> current-hall-name;
    in-out property <string> current-host-name;
    in-out property <string> current-user-role;
    in-out property <string> hall-error;

    // Chat state
    in-out property <[MessageItem]> messages: [];

    // Members state
    in-out property <[MemberItem]> members: [];
    in-out property <string> current-user-id;

    // Chest state
    in-out property <[ChestFileItem]> chest-files: [];
    in-out property <string> chest-path;
    in-out property <string> chest-status;

    // Action status (non-fatal errors)
    in-out property <string> member-action-status;

    // Switcher state
    in-out property <[SwitcherHallItem]> switcher-halls: [];
    property <bool> show-switcher: false;
    in-out property <string> switcher-search-text: "";

    // Keyboard navigation state
    property <int> selected-hall-index: -1;

    // Network state
    in-out property <string> network-status: "Working offline";
    in-out property <bool> is-network-connected: false;
    in-out property <string> invite-url: "";
    in-out property <string> connection-quality: "";  // "Good", "OK", "Poor", or ""

    // Typing indicator
    in-out property <string> typing-indicator: "";

    // Workspace state
    in-out property <[TabItem]> workspace-tabs: [];
    in-out property <string> active-tool: "chat";  // "chat", "tools", "files"

    // Launched Tools state (honest: opens in new window)
    in-out property <[LaunchedToolItem]> launched-tools: [];
    in-out property <[PinnedLauncherItem]> pinned-launchers: [];

    // Files state
    in-out property <string> files-path: "";
    in-out property <[FileItem]> files-entries: [];

    // Launcher state
    in-out property <[LauncherItem]> launcher-items: [];
    in-out property <bool> show-launcher: false;

    // Step-out state (K4)
    in-out property <bool> show-step-out-confirm: false;
    in-out property <string> step-out-warning: "";  // Warning message if host/last active

    // Switcher filtering callback
    callback filter-switcher-halls(string);

    // Step-out callbacks (K4)
    callback request-step-out();  // Request to step out (may show confirmation)
    callback confirm-step-out();  // Actually step out after confirmation

    // Network callbacks
    callback copy-invite();
    callback regenerate-invite();

    // Auth callbacks
    callback login(string, string);
    callback register(string, string);
    callback logout();

    // Hall callbacks
    callback load-halls();
    callback create-hall(string);
    callback select-hall(string);
    callback join-with-invite(string);
    callback create-invite(int) -> string;
    callback leave-hall();  // Deprecated - use request-step-out for K4 softer language

    // Chat callbacks
    callback load-messages();
    callback send-message(string);
    callback delete-message(string);
    callback typing-changed();

    // Member callbacks
    callback load-members();
    callback promote-member(string);
    callback demote-member(string);
    callback kick-member(string);

    // Chest callbacks
    callback load-chest-files();

    // Workspace callbacks
    callback select-tab(string);
    callback close-tab(string);
    callback launcher-select(int);
    callback stop-tool(string);         // Stop a launched tool by ID
    callback launch-pinned(string);     // Launch a pinned launcher by ID
    callback files-navigate(string);
    callback files-open(string);

    // Auth view (visible when not logged in)
    AuthView {
        visible: !root.is-logged-in;
        error-text: root.auth-error;
        login(u, p) => { root.login(u, p); }
        register(u, p) => { root.register(u, p); }
    }

    // Main app view (visible when logged in)
    VerticalLayout {
        visible: root.is-logged-in;

        // Top bar
        Rectangle {
            height: 36px;
            background: Theme.color-panel;

            HorizontalLayout {
                padding-left: Theme.pad-md;
                padding-right: Theme.pad-md;

                Text {
                    text: "Exom";
                    color: Theme.color-text;
                    font-size: Theme.text-md;
                    font-weight: 600;
                    vertical-alignment: center;
                }

                Rectangle { horizontal-stretch: 1; }

                // Network status indicator
                VerticalLayout {
                    alignment: center;

                    Rectangle {
                        width: 8px;
                        height: 8px;
                        border-radius: 4px;
                        background: root.is-network-connected ? Theme.color-online : Theme.color-text-dim;
                    }
                }

                Rectangle { width: 4px; }

                Text {
                    text: root.network-status;
                    color: Theme.color-text-muted;
                    font-size: Theme.text-xs;
                    vertical-alignment: center;
                }

                // Connection quality (only when connected and quality available)
                if root.is-network-connected && root.connection-quality != "": Text {
                    text: "(" + root.connection-quality + ")";
                    color: root.connection-quality == "Good" ? Theme.color-online :
                           (root.connection-quality == "OK" ? Theme.color-text-muted : Theme.color-text-dim);
                    font-size: Theme.text-xs;
                    vertical-alignment: center;
                }

                Rectangle { width: Theme.pad-md; }

                Text {
                    text: root.current-username;
                    color: Theme.color-text-muted;
                    font-size: Theme.text-sm;
                    vertical-alignment: center;
                }

                Rectangle { width: Theme.pad-md; }

                Button {
                    label: "Logout";
                    clicked => { root.logout(); }
                }
            }
        }

        // Three-panel layout
        HorizontalLayout {
            vertical-stretch: 1;

            // Left panel - Halls
            HallsPanel {
                halls: root.halls;
                current-hall-id: root.current-hall-id;
                error-text: root.hall-error;
                keyboard-selected-index: root.selected-hall-index;
                select-hall(id) => {
                    root.select-hall(id);
                }
                create-hall(name) => { root.create-hall(name); }
                join-with-invite(token) => { root.join-with-invite(token); }
            }

            VerticalSeparator {}

            // Center panel - Workspace (replaces ChatPanel)
            workspace-panel := WorkspacePanel {
                horizontal-stretch: 1;
                visible: root.current-hall-id != "";

                // Tab state
                tabs: root.workspace-tabs;
                active-tool: root.active-tool;

                // Chat state (passed through)
                hall-name: root.current-hall-name;
                host-name: root.current-host-name;
                user-role: root.current-user-role;
                messages: root.messages;
                typing-indicator: root.typing-indicator;

                // Launched Tools state (honest: opens in new window)
                launched-tools: root.launched-tools;
                pinned-launchers: root.pinned-launchers;

                // Files state
                files-path: root.files-path;
                files-entries: root.files-entries;

                // Callbacks
                select-tab(id) => { root.select-tab(id); }
                close-tab(id) => { root.close-tab(id); }
                send-message(msg) => { root.send-message(msg); }
                delete-message(id) => { root.delete-message(id); }
                typing-changed => { root.typing-changed(); }
                stop-tool(id) => { root.stop-tool(id); }
                launch-pinned(id) => { root.launch-pinned(id); }
                files-navigate(path) => { root.files-navigate(path); }
                files-open(path) => { root.files-open(path); }
                step-out => { root.request-step-out(); }
            }

            EmptyChatPanel {
                horizontal-stretch: 1;
                visible: root.current-hall-id == "";
            }

            VerticalSeparator {}

            // Right panel - Members (always present, visibility controlled)
            MembersPanel {
                visible: root.current-hall-id != "";
                members: root.members;
                chest-files: root.chest-files;
                chest-path: root.chest-path;
                chest-status: root.chest-status;
                current-user-id: root.current-user-id;
                current-user-role: root.current-user-role;
                action-status: root.member-action-status;
                network-status: root.network-status;
                is-network-connected: root.is-network-connected;
                invite-url: root.invite-url;
                is-host: root.current-host-name == root.current-username;
                promote-member(id) => { root.promote-member(id); }
                demote-member(id) => { root.demote-member(id); }
                kick-member(id) => { root.kick-member(id); }
                load-chest-files => { root.load-chest-files(); }
                copy-invite => { root.copy-invite(); }
                regenerate-invite => { root.regenerate-invite(); }
            }

            // Empty right panel placeholder
            Rectangle {
                visible: root.current-hall-id == "";
                width: Theme.right-panel-width;
                background: Theme.color-panel;
            }
        }

        // Global keyboard handling (OSV-first: Alt/Ctrl/Shift/Esc only)
        FocusScope {
            key-pressed(event) => {
                // Ctrl+Space: Open launcher
                if event.modifiers.control && event.text == " " {
                    if root.current-hall-id != "" {
                        root.show-launcher = true;
                    }
                    return accept;
                }
                // Alt+X: Open hall switcher
                if event.modifiers.alt && event.text == "x" {
                    root.show-switcher = true;
                    root.filter-switcher-halls("");
                    hall-switcher.focus-search();
                    return accept;
                }
                // Alt+J: Move selection down in halls list
                if event.modifiers.alt && event.text == "j" {
                    if root.halls.length > 0 {
                        if root.selected-hall-index < root.halls.length - 1 {
                            root.selected-hall-index = root.selected-hall-index + 1;
                        }
                    }
                    return accept;
                }
                // Alt+K: Move selection up in halls list
                if event.modifiers.alt && event.text == "k" {
                    if root.halls.length > 0 {
                        if root.selected-hall-index > 0 {
                            root.selected-hall-index = root.selected-hall-index - 1;
                        } else if root.selected-hall-index == -1 {
                            root.selected-hall-index = 0;
                        }
                    }
                    return accept;
                }
                // Alt+Enter: Activate selected hall
                if event.modifiers.alt && event.text == Key.Return {
                    if root.selected-hall-index >= 0 && root.selected-hall-index < root.halls.length {
                        root.select-hall(root.halls[root.selected-hall-index].id);
                    }
                    return accept;
                }
                // Esc: Close any open modal
                if event.text == Key.Escape {
                    if root.show-launcher {
                        root.show-launcher = false;
                        return accept;
                    }
                    if root.show-switcher {
                        root.show-switcher = false;
                        return accept;
                    }
                    return accept;
                }
                return reject;
            }
        }

        // Hall quick switcher overlay (Alt+X)
        hall-switcher := HallSwitcher {
            halls: root.switcher-halls;
            show: root.show-switcher;
            search-text <=> root.switcher-search-text;
            select-hall(id) => {
                root.select-hall(id);
            }
            close-requested => {
                root.show-switcher = false;
            }
            search-changed(text) => {
                root.filter-switcher-halls(text);
            }
        }

        // Launcher overlay (Ctrl+Space)
        Launcher {
            items: root.launcher-items;
            show: root.show-launcher;
            select(id) => {
                root.launcher-select(id);
            }
            close-requested => {
                root.show-launcher = false;
            }
        }

        // Step-out confirmation dialog (K4)
        if root.show-step-out-confirm: Rectangle {
            width: 100%;
            height: 100%;
            background: #00000066;

            Rectangle {
                width: 280px;
                height: root.step-out-warning != "" ? 160px : 120px;
                background: Theme.color-panel-elevated;
                border-radius: Theme.radius-md;
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;

                TouchArea {}  // Block clicks through

                VerticalLayout {
                    padding: Theme.pad-lg;
                    spacing: Theme.pad-md;
                    alignment: center;

                    Text {
                        text: "Step out of this hall?";
                        color: Theme.color-text;
                        font-size: Theme.text-md;
                        font-weight: 500;
                        horizontal-alignment: center;
                    }

                    if root.step-out-warning != "": Text {
                        text: root.step-out-warning;
                        color: Theme.color-text-muted;
                        font-size: Theme.text-sm;
                        horizontal-alignment: center;
                        wrap: word-wrap;
                    }

                    HorizontalLayout {
                        spacing: Theme.pad-md;
                        alignment: center;

                        SecondaryButton {
                            label: "Cancel";
                            clicked => { root.show-step-out-confirm = false; }
                        }

                        Button {
                            label: "Step out";
                            clicked => {
                                root.show-step-out-confirm = false;
                                root.confirm-step-out();
                            }
                        }
                    }
                }
            }
        }
    }

    // Load halls on login
    init => {
        if root.is-logged-in {
            root.load-halls();
        }
    }
}
