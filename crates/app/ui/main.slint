// Exom Main Window

import { Theme } from "theme.slint";
import { VerticalSeparator, Button } from "components.slint";
import { AuthView } from "auth.slint";
import { HallsPanel, HallItem } from "halls_panel.slint";
import { ChatPanel, EmptyChatPanel, MessageItem } from "chat_panel.slint";
import { MembersPanel, MemberItem, ChestFileItem } from "members_panel.slint";
import { HallSwitcher, SwitcherHallItem } from "hall_switcher.slint";

export { HallItem, MessageItem, MemberItem, ChestFileItem, SwitcherHallItem }

export component MainWindow inherits Window {
    title: "Exom";
    background: Theme.color-bg;
    min-width: 900px;
    min-height: 600px;
    preferred-width: 1200px;
    preferred-height: 800px;

    // Auth state
    in-out property <bool> is-logged-in: false;
    in-out property <string> current-username;
    in-out property <string> auth-error;

    // Hall state
    in-out property <[HallItem]> halls: [];
    in-out property <string> current-hall-id;
    in-out property <string> current-hall-name;
    in-out property <string> current-host-name;
    in-out property <string> current-user-role;
    in-out property <string> hall-error;

    // Chat state
    in-out property <[MessageItem]> messages: [];

    // Members state
    in-out property <[MemberItem]> members: [];
    in-out property <string> current-user-id;

    // Chest state
    in-out property <[ChestFileItem]> chest-files: [];
    in-out property <string> chest-path;
    in-out property <string> chest-status;

    // Action status (non-fatal errors)
    in-out property <string> member-action-status;

    // Switcher state
    in-out property <[SwitcherHallItem]> switcher-halls: [];
    property <bool> show-switcher: false;
    in-out property <string> switcher-search-text: "";

    // Keyboard navigation state
    property <int> selected-hall-index: -1;

    // Network state
    in-out property <string> network-status: "Working offline";
    in-out property <bool> is-network-connected: false;
    in-out property <string> invite-url: "";

    // Typing indicator
    in-out property <string> typing-indicator: "";

    // Switcher filtering callback
    callback filter-switcher-halls(string);

    // Network callbacks
    callback copy-invite();

    // Auth callbacks
    callback login(string, string);
    callback register(string, string);
    callback logout();

    // Hall callbacks
    callback load-halls();
    callback create-hall(string);
    callback select-hall(string);
    callback join-with-invite(string);
    callback create-invite(int) -> string;
    callback leave-hall();

    // Chat callbacks
    callback load-messages();
    callback send-message(string);
    callback delete-message(string);
    callback typing-changed();

    // Member callbacks
    callback load-members();
    callback promote-member(string);
    callback demote-member(string);
    callback kick-member(string);

    // Chest callbacks
    callback load-chest-files();

    // Auth view (visible when not logged in)
    AuthView {
        visible: !root.is-logged-in;
        error-text: root.auth-error;
        login(u, p) => { root.login(u, p); }
        register(u, p) => { root.register(u, p); }
    }

    // Main app view (visible when logged in)
    VerticalLayout {
        visible: root.is-logged-in;

        // Top bar
        Rectangle {
            height: 36px;
            background: Theme.color-panel;

            HorizontalLayout {
                padding-left: Theme.pad-md;
                padding-right: Theme.pad-md;

                Text {
                    text: "Exom";
                    color: Theme.color-text;
                    font-size: Theme.text-md;
                    font-weight: 600;
                    vertical-alignment: center;
                }

                Rectangle { horizontal-stretch: 1; }

                // Network status indicator
                VerticalLayout {
                    alignment: center;

                    Rectangle {
                        width: 8px;
                        height: 8px;
                        border-radius: 4px;
                        background: root.is-network-connected ? Theme.color-online : Theme.color-text-dim;
                    }
                }

                Rectangle { width: 4px; }

                Text {
                    text: root.network-status;
                    color: Theme.color-text-muted;
                    font-size: Theme.text-xs;
                    vertical-alignment: center;
                }

                Rectangle { width: Theme.pad-md; }

                Text {
                    text: root.current-username;
                    color: Theme.color-text-muted;
                    font-size: Theme.text-sm;
                    vertical-alignment: center;
                }

                Rectangle { width: Theme.pad-md; }

                Button {
                    label: "Logout";
                    clicked => { root.logout(); }
                }
            }
        }

        // Three-panel layout
        HorizontalLayout {
            vertical-stretch: 1;

            // Left panel - Halls
            HallsPanel {
                halls: root.halls;
                current-hall-id: root.current-hall-id;
                error-text: root.hall-error;
                keyboard-selected-index: root.selected-hall-index;
                select-hall(id) => {
                    root.select-hall(id);
                    // Focus chat input after selecting hall
                    chat-panel.focus-input();
                }
                create-hall(name) => { root.create-hall(name); }
                join-with-invite(token) => { root.join-with-invite(token); }
            }

            VerticalSeparator {}

            // Center panel - Chat (always present for focus management)
            chat-panel := ChatPanel {
                horizontal-stretch: 1;
                visible: root.current-hall-id != "";
                hall-name: root.current-hall-name;
                host-name: root.current-host-name;
                user-role: root.current-user-role;
                messages: root.messages;
                typing-indicator: root.typing-indicator;
                send-message(msg) => { root.send-message(msg); }
                delete-message(id) => { root.delete-message(id); }
                typing-changed => { root.typing-changed(); }
            }

            EmptyChatPanel {
                horizontal-stretch: 1;
                visible: root.current-hall-id == "";
            }

            VerticalSeparator {}

            // Right panel - Members (always present, visibility controlled)
            MembersPanel {
                visible: root.current-hall-id != "";
                members: root.members;
                chest-files: root.chest-files;
                chest-path: root.chest-path;
                chest-status: root.chest-status;
                current-user-id: root.current-user-id;
                current-user-role: root.current-user-role;
                action-status: root.member-action-status;
                network-status: root.network-status;
                is-network-connected: root.is-network-connected;
                invite-url: root.invite-url;
                promote-member(id) => { root.promote-member(id); }
                demote-member(id) => { root.demote-member(id); }
                kick-member(id) => { root.kick-member(id); }
                load-chest-files => { root.load-chest-files(); }
                copy-invite => { root.copy-invite(); }
            }

            // Empty right panel placeholder
            Rectangle {
                visible: root.current-hall-id == "";
                width: Theme.right-panel-width;
                background: Theme.color-panel;
            }
        }

        // Global keyboard handling (OSV-first: Alt/Ctrl/Shift/Esc only)
        FocusScope {
            key-pressed(event) => {
                // Alt+X: Open hall switcher
                if event.modifiers.alt && event.text == "x" {
                    root.show-switcher = true;
                    root.filter-switcher-halls("");
                    hall-switcher.focus-search();
                    return accept;
                }
                // Alt+J: Move selection down in halls list
                if event.modifiers.alt && event.text == "j" {
                    if root.halls.length > 0 {
                        if root.selected-hall-index < root.halls.length - 1 {
                            root.selected-hall-index = root.selected-hall-index + 1;
                        }
                    }
                    return accept;
                }
                // Alt+K: Move selection up in halls list
                if event.modifiers.alt && event.text == "k" {
                    if root.halls.length > 0 {
                        if root.selected-hall-index > 0 {
                            root.selected-hall-index = root.selected-hall-index - 1;
                        } else if root.selected-hall-index == -1 {
                            root.selected-hall-index = 0;
                        }
                    }
                    return accept;
                }
                // Alt+Enter: Activate selected hall
                if event.modifiers.alt && event.text == Key.Return {
                    if root.selected-hall-index >= 0 && root.selected-hall-index < root.halls.length {
                        root.select-hall(root.halls[root.selected-hall-index].id);
                        chat-panel.focus-input();
                    }
                    return accept;
                }
                // Esc: Close any open modal and return focus to chat
                if event.text == Key.Escape {
                    if root.show-switcher {
                        root.show-switcher = false;
                        if root.current-hall-id != "" {
                            chat-panel.focus-input();
                        }
                        return accept;
                    }
                    // Always focus chat on Esc
                    if root.current-hall-id != "" {
                        chat-panel.focus-input();
                    }
                    return accept;
                }
                return reject;
            }
        }

        // Hall quick switcher overlay (Alt+X)
        hall-switcher := HallSwitcher {
            halls: root.switcher-halls;
            show: root.show-switcher;
            search-text <=> root.switcher-search-text;
            select-hall(id) => {
                root.select-hall(id);
                // Focus chat input after selecting hall
                chat-panel.focus-input();
            }
            close-requested => {
                root.show-switcher = false;
                // Return focus to chat if hall is open
                if root.current-hall-id != "" {
                    chat-panel.focus-input();
                }
            }
            search-changed(text) => {
                root.filter-switcher-halls(text);
            }
        }
    }

    // Load halls on login
    init => {
        if root.is-logged-in {
            root.load-halls();
        }
    }
}
