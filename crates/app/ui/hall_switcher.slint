// Hall Quick Switcher Modal (Alt+X)

import { Theme } from "theme.slint";
import { TextField, ListItem } from "components.slint";

// Reuse HallItem structure
export struct SwitcherHallItem {
    id: string,
    name: string,
    role: string,
}

export component HallSwitcher inherits Rectangle {
    in property <[SwitcherHallItem]> halls: [];
    in property <bool> show: false;

    // Search and selection state
    in-out property <string> search-text: "";
    property <int> selected-index: 0;

    callback select-hall(string);
    callback close-requested();
    callback search-changed(string);

    // Full screen overlay
    background: root.show ? Theme.color-overlay : transparent;
    visible: root.show;

    // Backdrop click to close
    TouchArea {
        clicked => { root.close-requested(); }
    }

    // Keyboard handling for Esc and navigation
    scope := FocusScope {
        enabled: root.show;

        key-pressed(event) => {
            if event.text == Key.Escape {
                root.close-requested();
                return accept;
            }
            // Alt+J: Move selection down
            if event.modifiers.alt && event.text == "j" {
                if root.halls.length > 0 && root.selected-index < root.halls.length - 1 {
                    root.selected-index = root.selected-index + 1;
                }
                return accept;
            }
            // Alt+K: Move selection up
            if event.modifiers.alt && event.text == "k" {
                if root.halls.length > 0 && root.selected-index > 0 {
                    root.selected-index = root.selected-index - 1;
                }
                return accept;
            }
            // Enter: Activate selected hall
            if event.text == Key.Return {
                if root.halls.length > 0 && root.selected-index >= 0 && root.selected-index < root.halls.length {
                    root.select-hall(root.halls[root.selected-index].id);
                    root.close-requested();
                }
                return accept;
            }
            return reject;
        }
    }

    // Modal container
    Rectangle {
        x: (parent.width - self.width) / 2;
        y: 100px;
        width: 400px;
        min-height: 80px;
        max-height: 400px;
        background: Theme.color-panel;
        border-color: Theme.color-border;
        border-width: Theme.border-width;
        border-radius: Theme.radius-md;

        // Prevent backdrop click from closing when clicking modal
        TouchArea {}

        VerticalLayout {
            padding: 0;

            // Search input
            Rectangle {
                height: 44px;
                background: Theme.color-panel-elevated;
                border-radius: Theme.radius-md;

                HorizontalLayout {
                    padding: Theme.pad-sm;

                    search-input := TextField {
                        placeholder: "Switch to hall...";
                        horizontal-stretch: 1;
                        text <=> root.search-text;
                        edited => {
                            // Reset selection and trigger filtering
                            root.selected-index = 0;
                            root.search-changed(root.search-text);
                        }
                    }
                }
            }

            // Hall list
            Flickable {
                vertical-stretch: 1;
                max-height: 320px;

                VerticalLayout {
                    padding: Theme.pad-xs;
                    spacing: 2px;

                    for hall[idx] in root.halls: ListItem {
                        keyboard-focused: idx == root.selected-index;

                        clicked => {
                            root.select-hall(hall.id);
                            root.close-requested();
                        }

                        HorizontalLayout {
                            padding-left: Theme.pad-sm;
                            padding-right: Theme.pad-sm;
                            spacing: Theme.pad-sm;

                            Text {
                                text: hall.name;
                                color: Theme.color-text;
                                font-size: Theme.text-md;
                                vertical-alignment: center;
                                horizontal-stretch: 1;
                                overflow: elide;
                            }

                            Text {
                                text: hall.role;
                                color: Theme.color-text-dim;
                                font-size: Theme.text-xs;
                                vertical-alignment: center;
                            }
                        }
                    }

                    // Empty state
                    if root.halls.length == 0: Rectangle {
                        height: 60px;

                        Text {
                            text: root.search-text != "" ? "No matching halls" : "No halls";
                            color: Theme.color-text-dim;
                            font-size: Theme.text-sm;
                            horizontal-alignment: center;
                            vertical-alignment: center;
                        }
                    }
                }
            }

            // Hint bar
            Rectangle {
                height: 28px;
                background: Theme.color-panel-elevated;
                border-radius: Theme.radius-md;

                HorizontalLayout {
                    padding-left: Theme.pad-sm;
                    padding-right: Theme.pad-sm;

                    Text {
                        text: "Alt+J/K navigate | Enter select | Esc close";
                        color: Theme.color-text-dim;
                        font-size: Theme.text-xs;
                        vertical-alignment: center;
                    }
                }
            }
        }
    }

    // Focus the search input when shown
    public function focus-search() {
        // Reset state first
        root.selected-index = 0;
        root.search-text = "";
        // Focus search input for text entry
        search-input.set-focus();
    }
}
