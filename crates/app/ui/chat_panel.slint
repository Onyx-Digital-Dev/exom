// Center panel - Chat and activity

import { Theme } from "theme.slint";
import { TextField, Button, Separator, RoleBadge, HostBadge } from "components.slint";

// Message data with grouping support
export struct MessageItem {
    id: string,
    sender-name: string,
    sender-role: string,
    content: string,
    timestamp: string,
    is-edited: bool,
    is-group-start: bool,  // True if first message in a group from same sender
    is-host: bool,         // True if sender is current host
}

export component ChatPanel inherits Rectangle {
    in property <string> hall-name;
    in property <string> host-name;
    in property <string> user-role;
    in property <[MessageItem]> messages;

    callback send-message(string);
    callback delete-message(string);

    background: Theme.color-bg;

    VerticalLayout {
        // Header
        Rectangle {
            height: 48px;
            background: Theme.color-panel;

            HorizontalLayout {
                padding-left: Theme.pad-md;
                padding-right: Theme.pad-md;

                VerticalLayout {
                    alignment: center;
                    spacing: 2px;

                    Text {
                        text: root.hall-name;
                        color: Theme.color-text;
                        font-size: Theme.text-lg;
                        font-weight: 500;
                    }

                    HorizontalLayout {
                        spacing: Theme.pad-md;

                        if root.host-name != "": HorizontalLayout {
                            spacing: Theme.pad-xs;

                            HostBadge {}

                            Text {
                                text: root.host-name;
                                color: Theme.color-text-muted;
                                font-size: Theme.text-xs;
                                vertical-alignment: center;
                            }
                        }

                        RoleBadge {
                            role: root.user-role;
                            subtle: true;
                        }
                    }
                }
            }
        }

        Separator {}

        // Message list
        Flickable {
            vertical-stretch: 1;

            VerticalLayout {
                padding: Theme.pad-md;
                spacing: 0;

                for msg in root.messages: Rectangle {
                    background: transparent;
                    // More space before group start, compact spacing within group
                    height: msg.is-group-start ? self.preferred-height + Theme.pad-md : self.preferred-height + 2px;

                    VerticalLayout {
                        spacing: 2px;
                        padding-top: msg.is-group-start ? Theme.pad-sm : 0;

                        // Header row - only shown for first message in group
                        if msg.is-group-start: HorizontalLayout {
                            spacing: Theme.pad-sm;

                            Text {
                                text: msg.sender-name;
                                color: Theme.color-accent;
                                font-size: Theme.text-sm;
                                font-weight: 500;
                            }

                            if msg.is-host: HostBadge {}

                            RoleBadge {
                                role: msg.sender-role;
                                subtle: true;
                            }

                            Text {
                                text: msg.timestamp;
                                color: Theme.color-text-dim;
                                font-size: Theme.text-xs;
                            }
                        }

                        // Content row with inline timestamp for grouped messages
                        HorizontalLayout {
                            spacing: Theme.pad-sm;

                            // Indent grouped messages slightly to align with header content
                            if !msg.is-group-start: Rectangle {
                                width: 0;
                            }

                            Text {
                                text: msg.content;
                                color: Theme.color-text;
                                font-size: Theme.text-md;
                                wrap: word-wrap;
                                horizontal-stretch: 1;
                            }

                            // Compact timestamp on hover for grouped messages
                            if !msg.is-group-start: Text {
                                text: msg.timestamp;
                                color: Theme.color-text-dim;
                                font-size: Theme.text-xs;
                                vertical-alignment: center;
                            }

                            if msg.is-edited: Text {
                                text: "(edited)";
                                color: Theme.color-text-dim;
                                font-size: Theme.text-xs;
                                vertical-alignment: center;
                            }
                        }
                    }
                }
            }
        }

        Separator {}

        // Compose bar
        Rectangle {
            height: 56px;
            background: Theme.color-panel;

            HorizontalLayout {
                padding: Theme.pad-sm;
                spacing: Theme.pad-sm;

                message-input := TextField {
                    horizontal-stretch: 1;
                    placeholder: "Type a message...";
                    accepted => {
                        if self.text != "" {
                            root.send-message(self.text);
                            self.clear();
                            // Focus stays on input - typing-first UX
                            self.set-focus();
                        }
                    }
                }

                Button {
                    label: "Send";
                    primary: true;
                    clicked => {
                        if message-input.text != "" {
                            root.send-message(message-input.text);
                            message-input.clear();
                            // Focus stays on input - typing-first UX
                            message-input.set-focus();
                        }
                    }
                }
            }
        }
    }

    // Focus the input when panel becomes visible
    public function focus-input() {
        message-input.set-focus();
    }
}

// Empty state when no hall selected
export component EmptyChatPanel inherits Rectangle {
    background: Theme.color-bg;

    VerticalLayout {
        alignment: center;
        spacing: Theme.pad-sm;

        Text {
            text: "No Hall Selected";
            color: Theme.color-text-muted;
            font-size: Theme.text-lg;
            horizontal-alignment: center;
        }

        Text {
            text: "Select a hall from the list or create a new one.";
            color: Theme.color-text-dim;
            font-size: Theme.text-sm;
            horizontal-alignment: center;
        }
    }
}
