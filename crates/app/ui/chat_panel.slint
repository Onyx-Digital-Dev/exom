// Center panel - Chat and activity

import { Theme } from "theme.slint";
import { TextField, Button, Separator, RoleBadge, HostBadge, EmptyState } from "components.slint";

// Message data with grouping support
export struct MessageItem {
    id: string,
    sender-name: string,
    sender-role: string,
    content: string,
    timestamp: string,
    is-edited: bool,
    is-group-start: bool,  // True if first message in a group from same sender
    is-host: bool,         // True if sender is current host
    is-system: bool,       // True for system messages (join/leave/host change)
    is-own: bool,          // True if message is from current user
    is-pending: bool,      // True if message delivery not yet confirmed
}

export component ChatPanel inherits Rectangle {
    in property <string> hall-name;
    in property <string> host-name;
    in property <string> user-role;
    in property <[MessageItem]> messages;

    callback send-message(string);
    callback delete-message(string);

    background: Theme.color-bg;

    VerticalLayout {
        // Header
        Rectangle {
            height: 48px;
            background: Theme.color-panel;

            HorizontalLayout {
                padding-left: Theme.pad-md;
                padding-right: Theme.pad-md;

                VerticalLayout {
                    alignment: center;
                    spacing: 2px;

                    Text {
                        text: root.hall-name;
                        color: Theme.color-text;
                        font-size: Theme.text-lg;
                        font-weight: 500;
                    }

                    HorizontalLayout {
                        spacing: Theme.pad-md;

                        if root.host-name != "": HorizontalLayout {
                            spacing: Theme.pad-xs;

                            HostBadge {}

                            Text {
                                text: root.host-name;
                                color: Theme.color-text-muted;
                                font-size: Theme.text-xs;
                                vertical-alignment: center;
                            }
                        }

                        RoleBadge {
                            role: root.user-role;
                            subtle: true;
                        }
                    }
                }
            }
        }

        Separator {}

        // Message list
        Flickable {
            vertical-stretch: 1;

            VerticalLayout {
                padding: Theme.pad-md;
                spacing: 0;

                // Empty state when no messages - encourage first message
                if root.messages.length == 0: EmptyState {
                    title: "Welcome to " + root.hall-name;
                    description: "Say hello to start the conversation.";
                    vertical-stretch: 1;
                }

                for msg in root.messages: Rectangle {
                    background: transparent;
                    // System messages get less vertical space
                    height: msg.is-system ? self.preferred-height + Theme.pad-xs :
                            (msg.is-group-start ? self.preferred-height + Theme.pad-md : self.preferred-height + 2px);

                    // System message (join/leave/host change) - subtle centered text
                    if msg.is-system: HorizontalLayout {
                        alignment: center;
                        padding-top: Theme.pad-xs;
                        padding-bottom: Theme.pad-xs;

                        Text {
                            text: "— " + msg.content + " —";
                            color: Theme.color-text-dim;
                            font-size: Theme.text-xs;
                            horizontal-alignment: center;
                        }
                    }

                    // Regular message
                    if !msg.is-system: VerticalLayout {
                        spacing: 2px;
                        padding-top: msg.is-group-start ? Theme.pad-sm : 0;

                        // Header row - only shown for first message in group
                        if msg.is-group-start: HorizontalLayout {
                            spacing: Theme.pad-sm;

                            Text {
                                text: msg.sender-name;
                                color: Theme.color-accent;
                                font-size: Theme.text-sm;
                                font-weight: 500;
                            }

                            if msg.is-host: HostBadge {}

                            RoleBadge {
                                role: msg.sender-role;
                                subtle: true;
                            }

                            Text {
                                text: msg.timestamp;
                                color: Theme.color-text-dim;
                                font-size: Theme.text-xs;
                            }

                            // Delivery indicator for own messages
                            if msg.is-own: Rectangle {
                                width: 6px;
                                height: 6px;
                                y: 4px;
                                border-radius: 3px;
                                background: msg.is-pending ? transparent : Theme.color-online;
                                border-width: msg.is-pending ? 1px : 0;
                                border-color: Theme.color-text-dim;
                            }
                        }

                        // Content row with inline timestamp for grouped messages
                        HorizontalLayout {
                            spacing: Theme.pad-sm;

                            // Indent grouped messages slightly to align with header content
                            if !msg.is-group-start: Rectangle {
                                width: 0;
                            }

                            Text {
                                text: msg.content;
                                color: Theme.color-text;
                                font-size: Theme.text-md;
                                wrap: word-wrap;
                                horizontal-stretch: 1;
                            }

                            // Compact timestamp on hover for grouped messages
                            if !msg.is-group-start: Text {
                                text: msg.timestamp;
                                color: Theme.color-text-dim;
                                font-size: Theme.text-xs;
                                vertical-alignment: center;
                            }

                            // Delivery indicator for own grouped messages
                            if !msg.is-group-start && msg.is-own: Rectangle {
                                width: 6px;
                                height: 6px;
                                border-radius: 3px;
                                background: msg.is-pending ? transparent : Theme.color-online;
                                border-width: msg.is-pending ? 1px : 0;
                                border-color: Theme.color-text-dim;
                            }

                            if msg.is-edited: Text {
                                text: "(edited)";
                                color: Theme.color-text-dim;
                                font-size: Theme.text-xs;
                                vertical-alignment: center;
                            }
                        }
                    }
                }
            }
        }

        Separator {}

        // Compose bar with send acknowledgment
        Rectangle {
            height: 56px;
            background: Theme.color-panel;
            // Brief highlight when message sent (resets on typing)
            border-width: compose-bar.sent-flash ? 2px : 0;
            border-color: Theme.color-accent;

            animate border-width {
                duration: 100ms;
            }

            compose-bar := Rectangle {
                property <bool> sent-flash: false;

                HorizontalLayout {
                    padding: Theme.pad-sm;
                    spacing: Theme.pad-sm;

                    message-input := TextField {
                        horizontal-stretch: 1;
                        placeholder: "Type a message...";
                        accepted => {
                            if self.text != "" {
                                root.send-message(self.text);
                                self.clear();
                                // Flash acknowledgment and refocus
                                compose-bar.sent-flash = true;
                                self.set-focus();
                            }
                        }
                        // Reset flash when user starts typing
                        edited => {
                            compose-bar.sent-flash = false;
                        }
                    }

                    send-btn := Button {
                        label: "Send";
                        primary: true;
                        clicked => {
                            if message-input.text != "" {
                                root.send-message(message-input.text);
                                message-input.clear();
                                // Flash acknowledgment and refocus
                                compose-bar.sent-flash = true;
                                message-input.set-focus();
                            }
                        }
                    }
                }
            }
        }
    }

    // Focus the input when panel becomes visible
    public function focus-input() {
        message-input.set-focus();
    }
}

// Empty state when no hall selected
export component EmptyChatPanel inherits Rectangle {
    background: Theme.color-bg;

    VerticalLayout {
        alignment: center;
        spacing: Theme.pad-sm;

        Text {
            text: "Select a Hall";
            color: Theme.color-text-muted;
            font-size: Theme.text-lg;
            horizontal-alignment: center;
        }

        Text {
            text: "Select a hall from the list or create a new one.";
            color: Theme.color-text-dim;
            font-size: Theme.text-sm;
            horizontal-alignment: center;
        }
    }
}
